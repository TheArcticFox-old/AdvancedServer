#include <Palette.h>
#include <stdint.h>
#define PALETTE_END (0xDEADB00B)
#define PALETTE_EPSILON (10)

uint32_t palettes_from[][20] = {
    { 0xe0a000, 0xe08000, 0xa06040, 0xc0c0e0, 0xa0a0c0, 0x606080, 0x202020, PALETTE_END  },
    { 0xe0a000, 0xe08000, 0xa06040, 0xe0e0e0, 0xc0c0e0, 0xa0a0c0, 0x606080, 0x800000, PALETTE_END },
    { 0x2d273b, 0x181421, 0xb3b3b3, 0x828282, 0x424242, PALETTE_END },
    { 0x2d273b, 0x181421, 0xd6d6d6, 0xb3b3b3, 0x828282, 0x424242, PALETTE_END },
    { 0xf84468, 0xd00020, 0x680020, 0xf8f8f8, 0xd0d4f8, 0xb0b0d0, 0x686888, 0xf80000, 0x880000, 0x202020, PALETTE_END },
    { 0xf84468, 0xd00020, 0x680020, 0xf8f8f8, 0xd0d4f8, 0xb0b0d0, 0x686888, 0x880000, PALETTE_END },
    { 0x771515, 0x470013, 0x1f000b, 0xd6d6d6, 0xb3b3b3, 0x828282, 0x424242, 0xd58f6e, 0x944b3d, 0xd6d6d6, PALETTE_END },
    { 0x771515, 0x470013, 0x1f000b, 0xd6d6d6, 0xb3b3b3, 0x828282, 0x424242, 0xd58f6e, 0x944b3d, PALETTE_END },
    { 0x800000, 0xe0a000, 0xe0e0e0, 0xc0c0e0, 0xa0a0c0, 0x606080, 0x202020, PALETTE_END },
    { 0xe00000, 0x800000, 0xe0a000, 0xe0e0e0, 0xc0c0e0, 0xa0a0c0, 0x606080, 0xe0a080, 0xa06040, PALETTE_END },
    { 0x470013, 0x1f000b, 0x976e2b, 0x64372b, 0xd6d6d6, 0xb3b3b3, 0x828282, 0x424242, 0x363636, 0x636363, 0x470000, 0x383838, 0x616161, PALETTE_END },
    { 0x470013, 0x1f000b, 0x976e2b, 0x64372b, 0xd6d6d6, 0xb3b3b3, 0x828282, 0x424242, PALETTE_END },
    { 0xf19dbb, 0xe65b8c, 0xa93559, 0xbb7655, 0xfcb037, 0xdc7605, 0xff7575, 0xe0e0e0, 0xc0c0e0, 0xa0a0c0, 0x606080, 0x202020, PALETTE_END },
    { 0xf19dbb, 0xe65b8c, 0xa93559, 0xbb7655, 0x800000, 0xe0e0e0, 0xc0c0e0, 0xa0a0c0, 0x606080, PALETTE_END },
    { 0x884440, 0x582c28, 0x301818, 0xd6d6d6, 0xb3b3b3, 0x828282, 0x424242, 0x9e4127, 0xd58f6e, PALETTE_END },
    { 0x884440, 0x582c28, 0x301818, 0x431a20, 0x260a0f, 0x632d33, 0xd6d6d6, 0xb3b3b3, 0x828282, 0x424242, PALETTE_END },
    { 0xeecba8, 0xe39c79, 0xc16b53, 0xfc8c04, 0xd5560b, 0xe00000, 0x800000, 0xe4e0e4, 0xc0c0e0, 0xa0a0c0, 0x606080, 0x202020, PALETTE_END },
    { 0xeecba8, 0xe39c79, 0xc16b53, 0xfc8c04, 0xd5560b, 0xa3330e, 0xe00000, 0x800000, 0xf3bb10, 0xc46a09, 0xe4e0e4, 0xc0c0e0, 0xa0a0c0, 0x606080, PALETTE_END },
    { 0x793379, 0x4b214b, 0x341634, 0x771515, 0x470013, 0x1f000b, 0x431a20, 0x260a0f, 0xe4e0e4, 0xb3b3b3, 0x828282, 0x424242, PALETTE_END },
    { 0x793379, 0x4b214b, 0x341634, 0x771515, 0x470013, 0x1f000b, 0x431a20, 0x260a0f, 0xb3b3b3, 0x828282, 0x424242, 0x000000, PALETTE_END },
    { 0xdf7f22, 0xaf631b, 0x7f4712, 0xf1be5f, 0xc3994c, 0x8b6c34, 0x6060e0, 0x3600ff, 0x2d008f, 0xc22313, 0xa21a0b, 0x721307, PALETTE_END },
    { 0xdf7f22, 0xaf631b, 0x7f4712, 0xf1be5f, 0xc3994c, 0x8b6c34, 0x6060e0, 0x3600ff, 0x2d008f, 0xc22313, 0xa21a0b, 0x721307, PALETTE_END },
    { 0x68232a, 0x421216, 0x260006, 0xe49c79, 0xbb6d4e, 0x66281d, 0x474784, 0x202886, 0x1b1342, 0x740000, 0x400000, 0x1c0000, 0x470000, 0x910000, 0x963423, PALETTE_END },
    { 0x68232a, 0x421216, 0x260006, 0xe49c79, 0xbb6d4e, 0x66281d, 0x474784, 0x202886, 0x1b1342, 0x740000, 0x400000, 0x1c0000, 0x000000, 0x470000, 0x910000, 0x963423, PALETTE_END },
    { 0x6b69ff, 0x2145d6, 0x21208c, 0xfffbff, 0xd6d7ff, 0xb5b2d6, 0x6b698c, 0x800000, 0xe00000, PALETTE_END },
    { 0x6b69ff, 0x2145d6, 0x21208c, 0xffb28c, 0xb56942, 0xfffbff, 0xd6d7ff, 0xb5b2d6, 0x6b698c, 0xff0000, 0x940000, 0x800000, 0xe00000, PALETTE_END },
    { 0x2c3974, 0x253060, 0x171f3c, 0x001b2e, 0x000e18, 0x058cf9, 0x2f608e, 0x463e8e, 0x0094ff, PALETTE_END },
    { 0x2c3974, 0x253060, 0x171f3c, 0x001b2e, 0x000e18, 0x058cf9, 0x2f608e, 0x463e8e, 0xfffbff, 0xd6d7ff, 0xa0a0c0, 0x606080, 0xb5b2d6, 0x6b698c, 0x606080, 0x0094ff, PALETTE_END },
    { 0x003f99, 0x01316a, 0x011535, 0xf2c4b5, 0x99766c, PALETTE_END },
    { 0x011535, 0x6b698c, 0x300909, 0x940001, 0xff0000, 0x01316a, 0x99766c, 0xcc0005, 0xff0001, 0xb8b8d8, 0x003f99, 0xf2c4b5, 0xd8d8f8, 0xfcfcfc, 0x222222, 0xff3338, 0x940000, 0x604239, PALETTE_END },
    { 0x177aff, 0x0f47c0, 0x102676, 0xf2a572, 0xb2622d, PALETTE_END },
    { 0x177aff, 0x0f47c0, 0x102676, 0xf2a572, 0xb2622d, 0xc40000, PALETTE_END }
};
#define PALETTE_FROM_SIZE (32)

uint32_t palettes_to[][20] = {
    { 0xe09600, 0xbf6900, 0x8f0e00, 0xa5a5a5, 0x848484, 0x424242, 0x000000, PALETTE_END },
    { 0xf89c00, 0xfa6000, 0xb80c00, 0xfcfcfc, 0xd8d8fc, 0xb4b4d8, 0x6c6c90, 0x800020, PALETTE_END },
    { 0x282848, 0x101430, 0xc0c0e0, 0xa0a0c0, 0x606080, PALETTE_END },
    { 0x482928, 0x301013, 0xddd0d0, 0xc1abaa, 0x83766d, 0x53524a, PALETTE_END },
    { 0xf02c28, 0x982020, 0x570000, 0xe0e0e0, 0xa5a5a5, 0x848484, 0x424242, 0x982020, 0x570000, 0x000000, PALETTE_END },
    { 0xfc0000, 0xac0000, 0x570000, 0xfcfcfc, 0xd8d8fc, 0xb4b4d8, 0x6c6c90, 0x800020, PALETTE_END },
    { 0x900005, 0x59000f, 0x210009, 0xddd0d0, 0xc1abaa, 0x83766d, 0x53524a, 0xfcb490, 0xb46c48, 0xddd0d0, PALETTE_END },
    { 0x9f002d, 0x68002c, 0x300019, 0xf8f8f8, 0xd0d4f8, 0xb0b0d0, 0x686888, 0xfcb490, 0xb46c48, PALETTE_END },
    { 0x570000, 0xffda00, 0xe0e0e0, 0xa5a5a5, 0x848484, 0x424242, 0x000000, PALETTE_END },
    { 0xb42448, 0x800020, 0xf89c00, 0xfcfcfc, 0xd8d8fc, 0xb4b4d8, 0x6c6c90, 0xf29a6e, 0xba5726, PALETTE_END },
    { 0x6e1717, 0x420f0f, 0xb19a27, 0x92791e, 0xddd0d0, 0xc1abaa, 0x83766d, 0x53524a, 0x6b5f5f, 0xafa3a3, 0x800000, 0x6b5f5f, 0xafa3a3, PALETTE_END },
    { 0x610000, 0x380000, 0xb39502, 0x8c6e00, 0xf8f8f8, 0xd0d4f8, 0xb0b0d0, 0x686888, PALETTE_END },
    { 0xe1a1cc, 0xd45a99, 0x802e42, 0xaa6644, 0xe08e00, 0xa06040, 0xe74200, 0xe0e0e0, 0xa5a5a5, 0x848484, 0x424242, 0x000000, PALETTE_END },
    { 0xff9cbe, 0xff3b65, 0xa61738, 0xba5726, 0x800020, 0xfcfcfc, 0xd8d8fc, 0xb4b4d8, 0x6c6c90, PALETTE_END },
    { 0xc97f7b, 0x8c4b48, 0x4d2626, 0xe0e0e0, 0xc0c0e0, 0xa0a0c0, 0x606080, 0x7f6948, 0xdab273, PALETTE_END },
    { 0xb35658, 0x882a3b, 0x4c101b, 0x97091c, 0x5b070a, 0xbf364a, 0xddd0d0, 0xc1abaa, 0x83766d, 0x53524a, PALETTE_END },
    { 0xf8e0b8, 0xe8c080, 0x987840, 0xf89000, 0xe05800, 0xf85800, 0x980000, 0xe4e0e4, 0xa5a5a5, 0x848484, 0x424242, 0x000000, PALETTE_END },
    { 0xfacb9c, 0xf69566, 0xdd5b37, 0xf89c00, 0xfa6000, 0xb80c00, 0xe70000, 0x800020, 0xf89c00, 0xdd5b37, 0xfcfcfc, 0xd8d8fc, 0xb4b4d8, 0x6c6c90, PALETTE_END },
    { 0x61315e, 0x3f2040, 0x291329, 0x960d19, 0x690000, 0x400000, 0x6e4435, 0x4d2d25, 0xddd0d0, 0xc1abaa, 0x83766d, 0x53524a, PALETTE_END },
    { 0xbb1a81, 0x7d1055, 0x520e40, 0xb91107, 0x97091c, 0x5b070a, 0x97091c, 0x5b070a, 0xc0c0e0, 0xa0a0c0, 0x606080, 0x212121, PALETTE_END },
    { 0xc56b36, 0x985329, 0x71371c, 0xe0c080, 0xb09256, 0x695128, 0x60a0e0, 0x2060e0, 0x2040a0, 0xc43612, 0xa02000, 0x800000, PALETTE_END },
    { 0xa3632b, 0x884c18, 0x69370c, 0xe9c094, 0xc48f76, 0x875741, 0x177aff, 0x2040c0, 0x202080, 0xe00020, 0xa00000, 0x620000, PALETTE_END },
    { 0x955f4a, 0x6e4435, 0x4d2d25, 0xdab273, 0xa1845c, 0x5e4d36, 0x6b69ff, 0x2145d6, 0x21208c, 0xa62005, 0x690000, 0x400000, 0x400000, 0xa1845c, 0xa1845c, PALETTE_END },
    { 0xc56b36, 0x985329, 0x71371c, 0xe0c080, 0xba9954, 0x755f2f, 0x4080c0, 0x2060a0, 0x204060, 0xc22313, 0xa21a0b, 0x721307, 0x202020, 0xa03219, 0x9a4827, 0xa76939, PALETTE_END },
    { 0x6c6cd8, 0x4848b4, 0x242490, 0xe4e0e4, 0xb3b3b3, 0x828282, 0x424242, 0x5a0000, 0xb30000, PALETTE_END },
    { 0x256ba9, 0x205a7a, 0x13374d, 0xe3b890, 0xa5826b, 0xddd0d0, 0xc1abaa, 0x83766d, 0x53524a, 0xd1322e, 0x731c1a, 0x5a0000, 0xb30000, PALETTE_END },
    { 0x2c6d74, 0x255a60, 0x173a3c, 0x002e20, 0x001811, 0x05f9b7, 0x137373, 0x132d46, 0x05f9b7, PALETTE_END },
    { 0x742c40, 0x602536, 0x3c1723, 0x2e0000, 0x170000, 0xff0000, 0x940000, 0x2e0000, 0xddd0d0, 0xc1abaa, 0x83766d, 0x53524a, 0xc1abaa, 0x83766d, 0x53524a, 0xff0000, PALETTE_END },
    { 0x0e38a3, 0x110b9f, 0x000f55, 0xe0a080, 0xa06040, PALETTE_END },
    { 0x3d0065, 0x3d0065, 0x3d0065, 0x3d0065, 0x0c0031, 0x0c0031, 0x0c0031, 0x0c0031, 0x0c0031, 0x0c0031, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x7300bf, 0x3d0065, 0x3d0065, PALETTE_END },
    { 0x6b69ff, 0x2145d6, 0x21208c, 0xffb28c, 0xb56942, PALETTE_END },
    { 0x353867, 0x292d50, 0x1c1f37, 0xc1bdb8, 0x898781, 0x800000, PALETTE_END }
};
#define PALETTE_TO_SIZE (32)

uint32_t palettes_custom[][5] = {
    { 0x800000, 0xe00000, PALETTE_END },
    { 0x800000, 0xe00000, PALETTE_END },
    { 0x880000, 0xf80000, PALETTE_END },
    { 0x840000, 0xe70000, PALETTE_END },
    { 0xe0a000, PALETTE_END },
    { 0x64372b, 0x976e2b, PALETTE_END },
    { 0x800000, 0xe00000, 0xff7575, PALETTE_END },
    { 0x260a0f, 0x431a20, 0x632d33, PALETTE_END },
    { 0x800000, 0xe00000, PALETTE_END },
    { 0x260a0f, 0x431a20, PALETTE_END },
    { 0x2d008f, 0x3600ff, 0x6060e0, 0x25518a, PALETTE_END },
    { 0x1b1342, 0x202886, 0x474784, PALETTE_END },
    { 0x940000, 0xff0000, PALETTE_END },
    { 0x940000, 0xff0000, PALETTE_END },
    { 0x940001, 0xff0001, PALETTE_END },
    { 0x177aff, 0x0f47c0, 0x102676, PALETTE_END }
};
#define PALETTE_CUSTOM_SIZE (16)

bool palette_within_epsilon(uint8_t a, uint8_t b)
{
    return a >= b - PALETTE_EPSILON && a <= b + PALETTE_EPSILON;
}

bool palette_player_validate(PeerData* v, Packet* packet)
{
    PacketRead(from, packet, packet_read8, uint8_t);
    PacketRead(id, packet, packet_read16, uint16_t);
    PacketRead(name, packet, packet_readstr, String);
    PacketRead(size, packet, packet_read8, uint8_t);

    // default
    if(size <= 0)
        return false;

    // Check for custom & correct id
    bool is_custom = strncmp(name.value, "custom", 6) == 0;
    RAssert(v->id == id);
    RAssert((size / 4) <= 19);
    
    uint32_t final[20][3] = {0};
    uint8_t final_len = 0;

    for(uint8_t i = 0; i < size / 4; i++)
    {
        PacketRead(r, packet, packet_read8, uint8_t);
        PacketRead(g, packet, packet_read8, uint8_t);
        PacketRead(b, packet, packet_read8, uint8_t);
        PacketRead(a, packet, packet_read8, uint8_t);
        
        final[final_len][0] = r;
        final[final_len][1] = g;
        final[final_len++][2] = b;
    }

    if(from)
    {
        for(int i = 0; i < (is_custom ? PALETTE_CUSTOM_SIZE : PALETTE_FROM_SIZE); i++)
        {
            uint8_t match = 0;
            uint8_t length = 0;
            
            while(1)
            {                
                uint32_t rgb = is_custom ? palettes_custom[i][length] : palettes_from[i][length];
                uint8_t r = (rgb >> 16) & 0xFF;
                uint8_t g = (rgb >> 8) & 0xFF;
                uint8_t b = rgb & 0xFF;

                if(palette_within_epsilon(final[length][0], r), palette_within_epsilon(final[length][1], g), palette_within_epsilon(final[length][2], b))
                    ++match;
                
                if(++length >= final_len)
                    break;

                if(is_custom)
                {
                    if(palettes_custom[i][length] == PALETTE_END)
                        break;
                }
                else
                {
                    if(palettes_from[i][length] == PALETTE_END)
                        break;
                }
            }

            if(match != 0 && match == length)
                return true;
        }
    }
    else
    {
        if(is_custom)
            return true;
        
        for(int i = 0; i < PALETTE_TO_SIZE; i++)
        {
            uint8_t match = 0;
            uint8_t length = 0;
            
            while(1)
            {                
                uint32_t rgb = palettes_to[i][length];
                uint8_t r = (rgb >> 16) & 0xFF;
                uint8_t g = (rgb >> 8) & 0xFF;
                uint8_t b = rgb & 0xFF;

                if(palette_within_epsilon(final[length][0], r), palette_within_epsilon(final[length][1], g), palette_within_epsilon(final[length][2], b))
                    ++match;
                
                if(++length >= final_len)
                    break;

                if(palettes_to[i][length] == PALETTE_END)
                    break;
            }

            if(match != 0 && match == length)
                return true;
        }
    }

    return false;
}